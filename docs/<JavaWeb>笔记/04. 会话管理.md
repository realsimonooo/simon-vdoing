---
title:  会话管理
date: 2021-03-29 19:42:28
permalink: /pages/ee3d46/
categories:
  - <JavaWeb>笔记
---


## 基本原理

由于Http协议为**无状态**通信协议，但是Web应用程序像有些功能需要多次请求来完成。会话管理是**记得此次请求和之后请求关系**的方式。



### 会话管理的实现方式：

#### 使用隐藏域：

将上一页的信息作为隐藏域传递给下一页。

```html
<input type="hidden" name="info" value="'"+<%=info1%>+"'">
```

#### 使用URL重写：

使用`get`请求参数的应用，当服务器响应上一次请求时，将某些相关的信息用**超链接方式**响应给浏览器，超链接中包括请求参数的信息：

```java
out.println("<a href=hello.do?start'"+hello+"'"> + "</a>")
```

#### `Cookie`

一种浏览器存储信息的方式。服务器响应浏览器的`set-cookie`标头，浏览器收到标头与数值后，会将其**以文件的形式**存储在计算机上。

`Cookie`的常见方法：

```java
// 新建Cookie
Cookie cookie = new Cookie("Cookie", "Catme");

// 设置Cookie的最大存活时间
// 单位为秒
// 0表示删除Cookie，负值表示永不存储
cookie.setMaxAge(7*24*60*60); // 设置一个信息的最大存活；

// 向客户端发送Cookie对象
response.addCookie(cookie);
```



#### `HttpSession`

... ⬇️

## `HttpSession`

### 原理

+ 由🐱Tomcat服务器负责创建，session是实现了HttpSession接口类的一个实例；

+ HttpSession对象用来记录客户与服务器的**连接信息**；

  > 每一个连接到服务器的客户端都是一个session，servlet容器使用此接口创建HTTP客户端和HTTP服务器之间的**会话**。会话将保留指定的时间段，跨多个连接或来自用户页面请求。一个会话通常对应于一个用户，该用户可能多次访问一个站点，通过此接口就可以查看和操作有关某个会话的信息，如会话标识符、创建时间和最后一次访问时间。

  Session的作用就是为了标识**一次会话**（确认用户），并且在一次会话（来此一个用户的多次请求）期间共享数据。



### 与`HttpSession`有关的方法

1. 获取Session对象

   ```java
   HttpSession session = request.getSession();
   ```

   当获取Session对象时，会先**判断Session对象是否存在**，如果存在，则获取；如果不存在，则创建。

2. 获取Session的**回话标识符**

   ```java
   String id = session.getId();
   ```

3. 获取Session**创建时间**

   ```java
   session.getCreationTime();
   ```

4. 获取**最后一次访问时间**

   ```java
   session.getLastAcessTime();
   ```

5. 判断是否是**新的**session对象

   ```java
   session.isNew();
   ```

   返回`true`or`false`



### Session标识符`JSESSIONID`

+ `sessionid`用于标识一次会话，是会话的唯一标志。

  > 每次请求到达服务器，如果开启了会话（访问Session），服务器会查看客户端是否会回传一个名为`JSESSIONID`的`Cookie`。
  >
  > ​		➡️如果有，服务器会根据`JSESSIONID`的值去查看是否含有id为该值的**Session对象**；⬇️
  >
  > ​				➡️如果有相应的Session对象，则认为这是之前标记的Session对象，返回该Session对象，**数据达到共享**；如果没有，则认为这是新的Session对象，会重新创建新的Session对象，并标记此次会话。
  >
  > ​		➡️如果没有，则判断为这是一个新的会话，创建一个新的Session对象，并用唯一的`sessionid`为此次会话做一个标志。

  > `JSESSIONID`是特殊的`Cookie`，当用户请求服务器时访问了Session，则服务器会创建名为`JSESSIONID`，值为Session（获取或者新创建）的`sessionid`对象，并添加到响应`response`对象中，响应给客户端，有效时间为关闭浏览器。

  > Session的底层实现是依赖`Cookie`实现的。

### Session域对象

Session标识一次会话，在一次会话中共享数据。此时Session作为**域对象**存在，可以添加数据、获取数据、移除数据。

+ Session域对象操作方法：

  ```java
  HttpSession session = request.getSession();
  session.setAttribute("username", "adimn");// 设置Session域对象
  	// 第二个参数为Object
  String username = session.getAttribute("username");// 获取指定名称的Session域对象
  session.removeAttribute("username");// 移除指定名称的Session域对象
  ```

+ ⚠️：当Session对象不存在或者存在两个不同的Session对象时，数据不能共享。



### Session生命周期

#### ⌚️修改Session到期时间

> 默认到期时间： 客户端第一次请求Servlet并且操作Session时，Session对象生成；
>
> ​	🐱tomcat中Session默认的到期时间为30分钟，即步操作界面的时间，一旦有操作则会重新计时⌛️。

1. 通过修改tomcat目录下`web.xml`文件：（修改Session默认到期时间）

   ```xml
   <!-- session默认最大不活动时间，单位为分钟 -->
   <session-config>
   	<session-timeout>30</session-timeout>
   </session-config>
   ```

2. 在程序中设定Session到期时间：

   ```java
   // 用⬇️方法设定Session最大不活动时间
   // 单位：秒
   session.setMaxInactiveInterval(15);
   
   // 查看Session最大不活动时间
   session.getMaxInactiveInterval();
   ```

3. 在程序中立即销毁Session：

   ```java
   session.invalidate() // 让Session立即失效
   ```

4. 关闭浏览器可使Session失效；